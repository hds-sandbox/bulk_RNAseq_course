on: 
  push:
    branches:
      - webpage
      - main
  workflow_dispatch:

name: Quarto Publish

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Install libcurl on Linux
        if: runner.os == 'Linux'
        run: sudo apt-get update -y && sudo apt-get install -y libcurl4-openssl-dev libharfbuzz-dev libfribidi-dev libglpk40 libglpk-dev libboost-all-dev

      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: make work folder with data
        if: runner.os == 'Linux'
        run: sudo mkdir -p /work/Intro_to_bulkRNAseq/

      - name: Get data
        if: runner.os == 'Linux'
        run: | 
          wget -O Data.zip  https://zenodo.org/records/12090853/files/Data.zip?download=1
          unzip Data.zip
          rm Data.zip
          mkdir -p Results

      - name: Install R
        uses: r-lib/actions/setup-r@v2

#      - name: Check renv paths
#        run: |
#          Rscript -e 'cat("Project Library:", renv::paths$library(), "\n")'
#          Rscript -e 'cat("Global Cache:", renv::paths$cache(), "\n")'

#      - name: Set custom renv library path
#        run: echo "RENV_PATHS_LIBRARY=~/renv/library/4.4.2/" >> $GITHUB_ENV
  
#      - name: Install R Dependencies
#        uses: r-lib/actions/setup-renv@v2
      - name: Install fgsea with C++14 compiler
        run: |
          # Set the C++14 compiler and flags for this session
          export CXX=g++-11
          export CXXFLAGS="-std=c++14"

          # Verify which compiler is being used
          g++-11 --version
          echo "Using compiler: $CXX"
          echo "Using CXXFLAGS: $CXXFLAGS"

          # Print R's understanding of the compilation environment
          R -e 'Sys.getenv(c("CXX", "CXXFLAGS"))'
          
          # Install fgsea from Bioconductor
          R -e 'install.packages("BiocManager")'
          R -e 'BiocManager::install(c("fgsea"))'
  
      - name: installations
        run: |
          R -e 'install.packages(c("devtools", "tidyverse", "RColorBrewer", "pheatmap", "ggrepel", "cowplot"))' 
          R -e 'devtools::install_github("stephenturner/annotables")'
          R -e 'BiocManager::install(c("DESeq2", "clusterProfiler", "DOSE", "org.Hs.eg.db", "pathview", "DEGreport", "tximport", "AnnotationHub", "ensembldb","apeglm","ggnewscale"))'
          R -e 'install.packages(c("rmarkdown", "markdown", "knitr"))' 
        env:
          GITHUB_PAT: ${{ secrets.TOKEN }}

      - name: Pull Notebooks folder content
        if: runner.os == 'Linux'
        run: |
          git clone https://github.com/hds-sandbox/bulk_RNAseq_course.git temp_repo
          cp -r temp_repo/Notebooks/*.Rmd develop
          cp -r temp_repo/Notebooks/img/* develop/img/
          rm -rf temp_repo

      - name: Render and Publish
        uses: quarto-dev/quarto-actions/publish@v2
        with:
          target: gh-pages
